```
# 准备在实验环境里创建 1 个角色，同时包含 Controller, Compute 和 Ceph Storage 的功能

# 基于 Controller 角色，着手准备 ControllerComputeHCI 角色

(overcloud) [stack@undercloud templates]$ diff -urN roles_data.yaml.orig roles_data.yaml | more 
--- roles_data.yaml.orig        2021-02-25 10:21:40.959706343 +0800
+++ roles_data.yaml     2021-02-25 12:53:35.651413111 +0800
@@ -2,7 +2,7 @@
 # File generated by TripleO
 ###############################################################################
 ###############################################################################
-# Role: Controller                                                            #
+# Role: Controller
 ###############################################################################
 - name: Controller
   description: |
@@ -23,17 +23,14 @@
       subnet: storage_mgmt_subnet
     Tenant:
       subnet: tenant_subnet
+  RoleParametersDefault:
+    TunedProfileName: "throughput-performance"
   # For systems with both IPv4 and IPv6, you may specify a gateway network for
   # each, such as ['ControlPlane', 'External']
   default_route_networks: ['External']
   HostnameFormatDefault: '%stackname%-controller-%index%'
   # Deprecated & backward-compatible values (FIXME: Make parameters consistent)
   # Set uses_deprecated_params to True if any deprecated params are used.
-  uses_deprecated_params: True
-  deprecated_param_extraconfig: 'controllerExtraConfig'
-  deprecated_param_flavor: 'OvercloudControlFlavor'
-  deprecated_param_image: 'controllerImage'
-  deprecated_nic_config_name: 'controller.yaml'
   update_serial: 1
   ServicesDefault:
     - OS::TripleO::Services::Aide
@@ -51,6 +48,8 @@
     - OS::TripleO::Services::CACerts
     - OS::TripleO::Services::CeilometerAgentCentral
     - OS::TripleO::Services::CeilometerAgentNotification
+    - OS::TripleO::Services::CephClient
+    - OS::TripleO::Services::CephOSD
     - OS::TripleO::Services::CephExternal
     - OS::TripleO::Services::CephGrafana
     - OS::TripleO::Services::CephMds
@@ -83,6 +82,11 @@
     - OS::TripleO::Services::CinderVolume
     - OS::TripleO::Services::Clustercheck
     - OS::TripleO::Services::Collectd
+    - OS::TripleO::Services::ComputeCeilometerAgent
+    - OS::TripleO::Services::ComputeNeutronCorePlugin
+    - OS::TripleO::Services::ComputeNeutronL3Agent
+    - OS::TripleO::Services::ComputeNeutronMetadataAgent
+    - OS::TripleO::Services::ComputeNeutronOvsAgent
     - OS::TripleO::Services::ContainerImagePrepare
     - OS::TripleO::Services::DesignateApi
     - OS::TripleO::Services::DesignateCentral
@@ -136,6 +140,7 @@
     - OS::TripleO::Services::MySQLClient
     - OS::TripleO::Services::NeutronApi
     - OS::TripleO::Services::NeutronBgpVpnApi
+    - OS::TripleO::Services::NeutronBgpVpnBagpipe
     - OS::TripleO::Services::NeutronSfcApi
     - OS::TripleO::Services::NeutronCorePlugin
     - OS::TripleO::Services::NeutronDhcpAgent
@@ -150,9 +155,14 @@
     - OS::TripleO::Services::NeutronVppAgent
     - OS::TripleO::Services::NeutronAgentsIBConfig
     - OS::TripleO::Services::NovaApi
+    - OS::TripleO::Services::NovaAZConfig
+    - OS::TripleO::Services::NovaCompute
     - OS::TripleO::Services::NovaConductor
     - OS::TripleO::Services::NovaIronic
+    - OS::TripleO::Services::NovaLibvirt
+    - OS::TripleO::Services::NovaLibvirtGuests
     - OS::TripleO::Services::NovaMetadata
+    - OS::TripleO::Services::NovaMigrationTarget
     - OS::TripleO::Services::NovaScheduler
     - OS::TripleO::Services::NovaVncProxy
     - OS::TripleO::Services::ContainersLogrotateCrond
@@ -164,6 +174,7 @@
     - OS::TripleO::Services::OpenStackClients
     - OS::TripleO::Services::OVNDBs
     - OS::TripleO::Services::OVNController
+    - OS::TripleO::Services::OVNMetadataAgent
     - OS::TripleO::Services::Pacemaker
     - OS::TripleO::Services::PankoApi
     - OS::TripleO::Services::PlacementApi

# 新的角色名字叫 Controller

# 设置环境变量 THT
export THT=/usr/share/openstack-tripleo-heat-templates/

# 删除已有的 overcloud
(undercloud) [stack@undercloud ~]$ openstack stack delete overcloud --yes

# 等待删除完成
(undercloud) [stack@undercloud ~]$ watch -n5 'openstack stack resource list -n5 overcloud | grep -Ev COMP'

# 删除 plan 
(undercloud) [stack@undercloud ~]$ openstack overcloud plan delete overcloud

# 删除并重建目录
(undercloud) [stack@undercloud ~]$ rm -rf ~/templates/environments
(undercloud) [stack@undercloud ~]$ rm -rf ~/templates/network
(undercloud) [stack@undercloud ~]$ mkdir -p ~/templates/environments

# 重新生成 ~/rendered
(undercloud) [stack@undercloud ~]$ rm -rf ~/rendered
(undercloud) [stack@undercloud ~]$ mkdir ~/rendered

# 生成包含角色 nic config 的可定制环境文件
(undercloud) [stack@undercloud ~]$ cd $THT
(undercloud) [stack@undercloud openstack-tripleo-heat-templates]$ tools/process-templates.py -r ~/templates/roles_data.yaml -n ~/templates/network_data.yaml -o ~/rendered

# 进入到 rendered 目录
(undercloud) [stack@undercloud openstack-tripleo-heat-templates]$ cd ~/rendered

# 拷贝 rendered/environments/network-environment.yaml 到 ~/templates/environments
(undercloud) [stack@undercloud rendered]$ cp environments/network-environment.yaml ~/templates/environments

# 重新拷贝 rendered/network 到 ~/templates
(undercloud) [stack@undercloud rendered]$ cp -rp network ~/templates

# 拷贝 rendered/environments/net-bond-with-vlans.yaml 到 ~/templates/environments/
(undercloud) [stack@undercloud rendered]$ cp environments/net-bond-with-vlans.yaml ~/templates/environments/

# 根据需要修改 ~/templates/network/config//bond-with-vlans/controller.yaml 

# 为 baremetal node 设置 properties capabilities
# 注意调整 role 和 index
(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='boot_option:local' overcloud-ctrl01
(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='boot_option:local' overcloud-ctrl02
(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='boot_option:local' overcloud-ctrl03

(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='node:controller-0,boot_option:local' overcloud-ceph01
(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='node:controller-1,boot_option:local' overcloud-ceph02
(undercloud) [stack@undercloud ~]$ openstack baremetal node set --property capabilities='node:controller-2,boot_option:local' overcloud-ceph03

# 重新生成 ~/templates/node-info.yaml
cat > ~/templates/node-info.yaml << 'EOF'
parameter_defaults:
  ControllerCount: 3
  ComputeCount: 0
  ComputeHCICount: 0

  # SchedulerHints
  ControllerSchedulerHints:
    'capabilities:node': 'controller-%index%'
  ComputeSchedulerHints:
    'capabilities:node': 'compute-%index%'
  ComputeHCISchedulerHints:
    'capabilities:node': 'computehci-%index%'
EOF

# 重新生成 ~/templates/environments/fixed-ips.yaml 
cat > ~/templates/environments/fixed-ips.yaml << EOF
# This template allows the IPs to be preselected for each VIP. Note that
# this template should be included after other templates which affect the
# network such as network-isolation.yaml.

resource_registry:
  OS::TripleO::Network::Ports::ExternalVipPort: ../network/ports/external.yaml
  OS::TripleO::Network::Ports::InternalApiVipPort: ../network/ports/internal_api.yaml
  OS::TripleO::Network::Ports::StorageVipPort: ../network/ports/storage.yaml
  OS::TripleO::Network::Ports::StorageMgmtVipPort: ../network/ports/storage_mgmt.yaml
  OS::TripleO::Network::Ports::RedisVipPort: ../network/ports/vip.yaml
  OS::TripleO::Network::Ports::OVNDBsVipPort: ../network/ports/vip.yaml

parameter_defaults:
  # Set the IP addresses of the VIPs here.
  # NOTE: we will eventually move to one VIP per service
  #
  ControlFixedIPs: [{'ip_address':'192.0.2.240'}]
  PublicVirtualFixedIPs: [{'ip_address':'192.168.122.40'}]
  InternalApiVirtualFixedIPs: [{'ip_address':'172.16.2.240'}]
  StorageVirtualFixedIPs: [{'ip_address':'172.16.1.240'}]
  StorageMgmtVirtualFixedIPs: [{'ip_address':'172.16.3.240'}]
  RedisVirtualFixedIPs: [{'ip_address':'172.16.2.241'}]
  OVNDBsVirtualFixedIPs: [{'ip_address':'172.16.2.242'}]

  ControllerIPs:
    ctlplane:
    - 192.0.2.51
    - 192.0.2.52
    - 192.0.2.53
    storage:
    - 172.16.1.51
    - 172.16.1.52
    - 172.16.1.53
    storage_mgmt:
    - 172.16.3.51
    - 172.16.3.52
    - 172.16.3.53
    internal_api:
    - 172.16.2.51
    - 172.16.2.52
    - 172.16.2.53
    tenant:
    - 172.16.0.51
    - 172.16.0.52
    - 172.16.0.53
    external:
    - 192.168.122.31
    - 192.168.122.32
    - 192.168.122.33
EOF

# 更新 ~/templates/environments/network-environment.yaml 的 dns 配置
(undercloud) [stack@undercloud ~]$ sed -i 's/  DnsServers: \[\]/  DnsServers: ["192.168.122.3"]/' ~/templates/environments/network-environment.yaml
(undercloud) [stack@undercloud ~]$ grep DnsServers ~/templates/environments/network-environment.yaml

# 继续延用 ~/deploy-enable-tls-octavia.sh
(undercloud) [stack@undercloud ~]$ cat > ~/deploy-enable-tls-octavia.sh << 'EOF'
#!/bin/bash
THT=/usr/share/openstack-tripleo-heat-templates/
CNF=~/templates/

source ~/stackrc
openstack overcloud deploy --debug --templates $THT \
-r $CNF/roles_data.yaml \
-n $CNF/network_data.yaml \
-e $THT/environments/ceph-ansible/ceph-ansible.yaml \
-e $THT/environments/ceph-ansible/ceph-rgw.yaml \
-e $THT/environments/ssl/enable-internal-tls.yaml \
-e $THT/environments/ssl/tls-everywhere-endpoints-dns.yaml \
-e $THT/environments/network-isolation.yaml \
-e $CNF/environments/network-environment.yaml \
-e $CNF/environments/fixed-ips.yaml \
-e $CNF/environments/net-bond-with-vlans.yaml \
-e $THT/environments/services/octavia.yaml \
-e ~/containers-prepare-parameter.yaml \
-e $CNF/custom-domain.yaml \
-e $CNF/node-info.yaml \
-e $CNF/enable-tls.yaml \
-e $CNF/inject-trust-anchor.yaml \
-e $CNF/keystone_domain_specific_ldap_backend.yaml \
-e $CNF/cephstorage.yaml \
-e $CNF/fix-nova-reserved-host-memory.yaml \
--ntp-server 192.0.2.1
EOF

# 部署 overcloud
(undercloud) [stack@undercloud ~]$ time /bin/bash ~/deploy-enable-tls-octavia.sh

# 目前尚不工作
(undercloud) [stack@undercloud ~]$ cat /var/lib/mistral/overcloud/ansible.log | grep "fatal:" -A28
...
    "stderr": "<13>Feb 25 06:11:51 puppet-user: Warning: The function 'hiera' is deprecated in favor of using 'lookup'. See https://puppet.com/docs/puppet/5.5/deprecated_language.html\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: /etc/puppet/hiera.yaml: Use of 'hiera.yaml' version 3 is deprecated. It should be converted to version 5\n<13>Feb 25 06:12:05 puppet-user:    (file: /etc/puppet/hiera.yaml)\n<13>Feb 25 06:12:05 puppet-user: Warning: Undefined variable '::deploy_config_name'; \\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: ModuleLoader: module 'tripleo' has unresolved dependencies - it will only see those that are resolved. Use 'puppet module list --tree' to see information about modules\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: Undefined variable '::nova::params::vncproxy_service_name'; class nova::params has not been evaluated\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: ModuleLoader: module 'nova' has unresolved dependencies - it will only see those that are resolved. Use 'puppet module list --tree' to see information about modules\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: ModuleLoader: module 'openstacklib' has unresolved dependencies - it will only see those that are resolved. Use 'puppet module list --tree' to see information about modules\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: ModuleLoader: module 'concat' has unresolved dependencies - it will only see those that are resolved. Use 'puppet module list --tree' to see information about modules\\n   (file & line not available)\n<13>Feb 25 06:12:05 puppet-user: Warning: Unknown variable: '::deployment_type'. (file: /etc/puppet/modules/tripleo/manifests/profile/base/database/mysql/client.pp, line: 89, column: 8)\n<13>Feb 25 06:12:06 puppet-user: Warning: ModuleLoader: module 'pacemaker' has unresolved dependencies - it will only see those that are resolved. Use 'puppet module list --tree' to see information about modules\\n   (file & line not available)\n<13>Feb 25 06:12:07 puppet-user: Warning: tag is a metaparam; this value will inherit to all contained resources in the tripleo::firewall::rule definition\n<13>Feb 25 06:12:07 puppet-user: Notice: Scope(Class[Tripleo::Firewall::Post]): At this stage, all network traffic is blocked.\n<13>Feb 25 06:12:07 puppet-user: Error: Evaluation Error: Error while evaluating a Resource Statement, Evaluation Error: Error while evaluating a Resource Statement, Duplicate declaration: Exec[/etc/pki/CA/certs/vnc.crt] is already declared at (file: /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp, line: 87); cannot redeclare (file: /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp, line: 87) (file: /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp, line: 87, column: 5) (file: /etc/puppet/modules/tripleo/manifests/profile/base/certmonger_user.pp, line: 258) on node overcloud-controller-1.example.com",

# 备份 undercloud 上的 /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp 文件
(undercloud) [stack@undercloud ~]$ cp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp.orig

# 修改 undercloud 上的 /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp 文件
# 注释 exec { $cacertfile ... }
(undercloud) [stack@undercloud ~]$ diff -urN /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp.orig /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp
--- /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp.orig        2021-03-01 11:16:30.482048411 +0800
+++ /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp     2021-03-01 11:40:55.003322669 +0800
@@ -84,15 +84,15 @@
     # Sometimes certmonger returns before creating the cacert file. This has
     # been reported in: https://bugzilla.redhat.com/show_bug.cgi?id=1759281
     # Until this is fixed, add this workaround.
-    exec { $cacertfile :
-      require   => Certmonger_certificate[$name],
-      command   => "test -f ${cacertfile}",
-      unless    => "test -f ${cacertfile}",
-      tries     => 60,
-      try_sleep => 1,
-      timeout   => 60,
-      path      => '/usr/bin:/bin',
-    }
+    #exec { $cacertfile :
+    #  require   => Certmonger_certificate[$name],
+    #  command   => "test -f ${cacertfile}",
+    #  unless    => "test -f ${cacertfile}",
+    #  tries     => 60,
+    #  try_sleep => 1,
+    #  timeout   => 60,
+    #  path      => '/usr/bin:/bin',
+    #}
  
-    file { $cacertfile :
-      require => Exec[$cacertfile],
-      mode    => '0644'
-    }
+    #file { $cacertfile :
+    #  require => Exec[$cacertfile],
+    #  mode    => '0644'
+    #}
+    #~> Service<| title == $notify_service_real |>
+  #}
 
-  file { $service_certificate :
-    require => Certmonger_certificate[$name],
-    mode    => '0644'
-  }
-  file { $service_key :
-    require => Certmonger_certificate[$name],
-    group   => 'qemu',
-    mode    => '0640'
-  }
+  #file { $service_certificate :
+  #  require => Certmonger_certificate[$name],
+  #  mode    => '0644'
+  #}
+  #file { $service_key :
+  #  require => Certmonger_certificate[$name],
+  #  group   => 'qemu',
+  #  mode    => '0640'
+  #}
 
-  File[$service_certificate] ~> Service<| title == $notify_service_real |>
-  File[$service_key] ~> Service<| title == $notify_service_real |>
+  #File[$service_certificate] ~> Service<| title == $notify_service_real |>
+  #File[$service_key] ~> Service<| title == $notify_service_real |>
 }


# 拷贝修改过的 /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp 到 overcloud 节点
(undercloud) [stack@undercloud ~]$ scp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp heat-admin@overcloud-controller-0.ctlplane:/tmp
(undercloud) [stack@undercloud ~]$ ssh heat-admin@overcloud-controller-0.ctlplane 'sudo cp /tmp/libvirt_vnc.pp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp'

(undercloud) [stack@undercloud ~]$ scp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp heat-admin@overcloud-controller-1.ctlplane:/tmp
(undercloud) [stack@undercloud ~]$ ssh heat-admin@overcloud-controller-1.ctlplane 'sudo cp /tmp/libvirt_vnc.pp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp'

(undercloud) [stack@undercloud ~]$ scp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp heat-admin@overcloud-controller-2.ctlplane:/tmp
(undercloud) [stack@undercloud ~]$ ssh heat-admin@overcloud-controller-2.ctlplane 'sudo cp /tmp/libvirt_vnc.pp /etc/puppet/modules/tripleo/manifests/certmonger/libvirt_vnc.pp'
```